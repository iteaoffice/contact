{% do headTitle().append(translate("txt-edit-profile")) %}
<h1>{{ translate("txt-edit-profile") }}</h1>
<p class="lead">{{ translate("txt-edit-profile-explanation") }}</p>

{% do form.prepare() %}
{{ form().openTag(form)|raw }}

{{ ztbformelement(form.get('contact').get('gender')) }}
{{ ztbformelement(form.get('contact').get('title')) }}
{{ ztbformelement(form.get('contact').get('firstName')) }}
{{ ztbformelement(form.get('contact').get('middleName')) }}
{{ ztbformelement(form.get('contact').get('lastName')) }}

<div class="form-group row">
    <label class="col-sm-3 col-form-label">{{ translate("txt-email-address") }}</label>

    <div class="col-sm-9">
        <p class="form-control-plaintext">{{ contact.email }}</p>
    </div>
</div>


<fieldset class="bg-light border-light rounded p-3">
    <legend>{{ translate("txt-organisation") }}</legend>

    <div class="organisation {% if not hasOrganisations %}d-none{% endif %}">
        {{ ztbformelement(form.get('contact_organisation').get('organisation_id')) }}
        <div class="form-group row {% if not form.get('contact_organisation').get('organisation_id').value() != 0 %}d-none{% endif %}"
             id="branch">
            <label class="col-sm-3 col-form-label">{{ translate("txt-branch-form-label") }}</label>

            <div class="col-sm-9">
                <select class="form-control" name="contact_organisation[branch]">
                    {% for key, branch in branches %}
                        <option value="{{ key }}"
                                {% if data.contact_organisation.branch == key %}selected="selected"{% endif %}
                        >{{ branch }}</option>
                    {% endfor %}
                </select>

                <small class="fomr-text text-muted">{{ translate("txt-form-branch-explanation") }}</small>
            </div>
        </div>
    </div>
    <div id="organisation_country"
         {% if hasOrganisations and form.get('contact_organisation').get('organisation_id').value() != 0 %}class="d-none"{% endif %}>
        {{ ztbformelement(form.get('contact_organisation').get('organisation')) }}
        {{ ztbformelement(form.get('contact_organisation').get('type')) }}
        {{ ztbformelement(form.get('contact_organisation').get('country')) }}
    </div>
</fieldset>

<fieldset>
    <legend>{{ translate("txt-phone-information") }}</legend>
    {% for element in form.get('phone').getElements() %}
        {{ ztbformelement(element) }}
    {% endfor %}
</fieldset>

<fieldset>
    <legend>{{ translate("txt-postal-address") }}</legend>
    {% set address = form.get('address') %}

    {{ ztbformelement(address.get('address')) }}
    {{ ztbformelement(address.get('zipCode')) }}
    {{ ztbformelement(address.get('city')) }}
    {{ ztbformelement(address.get('country')) }}

</fieldset>

<fieldset>
    <legend>{{ translate("txt-profile") }}</legend>
    {% set profile = form.get('profile') %}
    {{ ztbformelement(profile.get('visible')) }}
    {{ ztbformelement(profile.get('description')) }}
    {{ ztbformelement(form.get('contact').get('department')) }}
    {{ ztbformelement(form.get('contact').get('position')) }}
</fieldset>

{% if not contact.photo.isEmpty() %}
    <div class="form-group row">
        <label class="col-sm-3 col-form-label">{{ translate("txt-current-photo") }}</label>

        <div class="col-sm-9">
            <p class="form-control-plaintext">{{ contactPhoto(contact, 200) }}</p>
        </div>
    </div>

    {{ ztbformelement(form.get('removeFile')) }}
{% endif %}

{{ ztbformelement(form.get('file')) }}
{{ ztbformelement(form.get('optIn')) }}
{{ ztbformelement(form.get('csrf')) }}

<div class="form-group row">
    <div class="offset-sm-3 col-sm-9">
        {{ ztbformelement(form.get('submit')) }}
        {{ ztbformelement(form.get('cancel')) }}
    </div>
</div>

{{ form().closeTag()|raw }}

<script type="text/javascript">
    $(function () {
        const updateFormInformation = function (radio) {
            if (radio.val() && radio.val() !== '0') {
                $.ajax({
                    url: '{{ serverUrl() }}{{ url('organisation/json/get-branches') }}',
                    type:
                        'post',
                    data:
                        {
                            'organisationId':
                                $('input[name="contact_organisation[organisation_id]"]:checked').val()
                        }
                    ,
                    success: function (response) {

                        const branchSelect = $("#branch").find('select');
                        /**
                         * Store the branchValue because the options are rebuilt every time
                         * Use the branch val on form change, and take the current branch in any other case
                         */
                        const branchValue = '{{ data.contact_organisation.branch|raw }}';
                        branchSelect.find('option').remove();
                        $(response).each(function () {
                            const option = $('<option />');
                            option.attr('value', this.value).text(this.label);

                            if (branchValue === this.value) {
                                option.attr('selected', 'selected');
                            }

                            branchSelect.append(option);
                        });
                    }
                })
                ;
            }
        };

        const $selectOrganisation = $('input[name="contact_organisation[organisation_id]"]');
        $selectOrganisation.change(function () {
            const self = $(this);
            const noneOfTheAbove = self.val() === '0';
            $("#organisation_country").toggleClass('d-none', !noneOfTheAbove);
            $("#branch").toggleClass('d-none', noneOfTheAbove);
            updateFormInformation(self);
        });

        updateFormInformation($selectOrganisation);

    });
</script>
